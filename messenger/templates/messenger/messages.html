{% extends 'layout.html' %}

{% block title %}Chat Messages{% endblock %}

{% block content %}
    <div class="chat-container">
        <h2>Chat Messages with {{ chat_data.other_user }}</h2>
        {% if chat_data.other_user_status %}
            <p>Онлайн</p>
        {% else %}
            <p>Оффлайн</p>
        {% endif %}
        <div id="chat-log">
            {% for message in chat_data.messages %}
                <table width="100%">
                    <tr>
                        {% if message.author__username == chat_data.current_user %}
                            <td align="right" width="70%">
                                <div style="background-color: #dcf8c6; padding: 10px; border-radius: 10px;">
                                    <p>{{ message.text }}</p>
                                    {% if message.picture_url %}
                                        <p><img src="{{ message.picture_url }}" width="150"> </p>
                                    {% endif %}
                                    <p style="font-size: 0.8em; color: #999;">{{ message.send_time|date:"d M Y, H:i" }}</p>
                                    <p style="font-size: 0.8em; color: #999;">{{ message.status }}</p>
                                    {% if not message.is_deleted %}
                                        <p><a href="{% url 'deletemessage' message_id=message.id %}">x</a></p>
                                    {% endif %}
                                </div>
                            </td>
                            <td width="30%"></td>
                        {% else %}
                            <td width="30%"></td>
                            <td align="left" width="70%">
                                <div style="background-color: #ffffff; padding: 10px; border-radius: 10px;">
                                    <p>{{ message.text }}</p>
                                    <p style="font-size: 0.8em; color: #999;">{{ message.send_time|date:"d M Y, H:i" }}</p>
                                    {% if message.picture_url %}
                                        <p><img src="{{ message.picture_url }}" width="150"> </p>
                                    {% endif %}
                                    {% if not message.is_deleted %}
                                        <p><a href="{% url 'deletemessage' message_id=message.id %}">x</a></p>
                                    {% endif %}
                                </div>
                            </td>
                        {% endif %}
                    </tr>
                </table>
            {% empty %}
                <p>No messages in this chat.</p>
            {% endfor %}
        </div>
        <form id="chat-message-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Отправить</button>
        </form>
    </div>

    <script>
        const chatId = {{ chat_data.chat_id }};
        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/' + chatId + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const chatLog = document.getElementById('chat-log');
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = `
                <table width="100%">
                    <tr>
                        {% if data.author__username == chat_data.current_user %}
                            <td align="right" width="70%">
                                <div style="background-color: #dcf8c6; padding: 10px; border-radius: 10px;">
                                    <p>${data.message}</p>
                                    {% if data.picture_url %}
                                        <p><img src="${data.picture_url}" width="150"> </p>
                                    {% endif %}
                                    <p style="font-size: 0.8em; color: #999;">${data.send_time}</p>
                                    <p style="font-size: 0.8em; color: #999;">${data.status}</p>
                                    {% if not data.is_deleted %}
                                        <p><a href="{% url 'deletemessage' message_id=data.id %}">x</a></p>
                                    {% endif %}
                                </div>
                            </td>
                            <td width="30%"></td>
                        {% else %}
                            <td width="30%"></td>
                            <td align="left" width="70%">
                                <div style="background-color: #ffffff; padding: 10px; border-radius: 10px;">
                                    <p>${data.message}</p>
                                    <p style="font-size: 0.8em; color: #999;">${data.send_time}</p>
                                    {% if data.picture_url %}
                                        <p><img src="${data.picture_url}" width="150"> </p>
                                    {% endif %}
                                    {% if not data.is_deleted %}
                                        <p><a href="/deletemessage/${data.id}/">x</a></p>
                                    {% endif %}
                                </div>
                            </td>
                        {% endif %}
                    </tr>
                </table>
            `;
            chatLog.appendChild(messageDiv);
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.getElementById('chat-message-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const messageInputDom = document.querySelector('#id_text');
            const message = messageInputDom.value;
            const authorId = {{ request.user.id }};
            chatSocket.send(JSON.stringify({
                'message': message,
                'chat_id': chatId,
                'author_id': authorId
            }));
            messageInputDom.value = '';
        });
    </script>
{% endblock %}
