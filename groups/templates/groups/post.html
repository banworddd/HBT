{% extends 'layout.html' %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
    <h1>{{ post.title }}</h1>
    <p><small>–ê–≤—Ç–æ—Ä:
        {% if not post.author %}
            –ê–¥–º–∏–Ω
        {% else %}
            {{ post.author.user.username }}
        {% endif %}
    </small></p>
    <p><small>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {{ post.pub_date }}</small></p>
    <p>{{ post.post }}</p>
    {% if post.picture1 %}
        <p><img src="{{ post.picture1.url }}" width="200"></p>
    {% endif %}
    {% if post.picture2 %}
        <p><img src="{{ post.picture2.url }}" width="200"></p>
    {% endif %}
    {% if post.picture3 %}
        <p><img src="{{ post.picture3.url }}" width="200"></p>
    {% endif %}
    {% if is_admin %}
        <a href="{% url 'editpost' post_slug=post.slug %}">–ò–∑–º–µ–Ω–∏—Ç—å</a>
        <a href="{% url 'deletepost' post_slug=post.slug %}">X</a>
    {% endif %}

    <!-- –ë–ª–æ–∫ —Ä–µ–∞–∫—Ü–∏–π –¥–ª—è –ø–æ—Å—Ç–∞ -->
    <div class="reaction-buttons">
        <span class="reaction-group">
            <a href="{% url 'sendreaction' post_slug=post.slug reaction='L' %}"
               class="reaction-button" data-reaction="L"
               style="background-color: {% if user_post_reaction.status == 'L' %}green{% else %}grey{% endif %}; {% if not is_subscriber %}pointer-events: none;{% endif %}">
                üëç {{ l_reactions }}
            </a>
        </span>

        <span class="reaction-group">
            <a href="{% url 'sendreaction' post_slug=post.slug reaction='D' %}"
               class="reaction-button" data-reaction="D"
               style="background-color: {% if user_post_reaction.status == 'D' %}green{% else %}grey{% endif %}; {% if not is_subscriber %}pointer-events: none;{% endif %}">
                üëé {{ d_reactions }}
            </a>
        </span>

        <span class="reaction-group">
            <a href="{% url 'sendreaction' post_slug=post.slug reaction='H' %}"
               class="reaction-button" data-reaction="H"
               style="background-color: {% if user_post_reaction.status == 'H' %}green{% else %}grey{% endif %}; {% if not is_subscriber %}pointer-events: none;{% endif %}">
                ‚ù§Ô∏è {{ h_reactions }}
            </a>
        </span>
    </div>

    <details>
        <summary>–ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</summary>
        {% if post_edits %}
            {% for edit in post_edits %}
                <p>–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: {{ edit.edit_date }}</p>
                <p>–ê–≤—Ç–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è: {{ edit.edit_author_name }}</p>
                <p>–ü—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è –ø–æ—Å—Ç–∞: {{ edit.post_previous }}</p>
                <p>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –ø–æ—Å—Ç–∞: {{ edit.post_next }}</p>
            {% endfor %}
        {% else %}
            <p>–ò–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ –±—ã–ª–æ</p>
        {% endif %}
    </details>

    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>
    {% if comments %}
        {% for comment in comments %}
            <div class="comment">
                <p><strong>{{ comment.comment_author.user.public_name }}</strong>: {{ comment.comment }}</p>
                <p><small>{{ comment.comment_date }}</small></p>

                <!-- –ë–ª–æ–∫ —Ä–µ–∞–∫—Ü–∏–π –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                <div class="reaction-buttons">
                    <span class="reaction-group">
                        <a href="{% url 'commentreaction' comment_id=comment.id reaction='L' %}"
                           class="reaction-button" data-reaction="L"
                           style="background-color: {% for reaction_item in user_comment_reactions %}
                                {% if reaction_item.0 == comment.id and reaction_item.1 == 'L' %}
                                    green
                                {% else %}
                                    grey
                                {% endif %}
                            {% endfor %}; {% if not is_subscriber %}pointer-events: none;{% endif %}">
                            üëç
                            {% for reaction_item in comments_reactions %}
                                {% if reaction_item.0 == comment.id %}
                                    {{ reaction_item.1.L|default:0 }}
                                {% endif %}
                            {% endfor %}
                        </a>
                    </span>

                    <span class="reaction-group">
                        <a href="{% url 'commentreaction' comment_id=comment.id reaction='D' %}"
                           class="reaction-button" data-reaction="D"
                           style="background-color: {% for reaction_item in user_comment_reactions %}
                                {% if reaction_item.0 == comment.id and reaction_item.1 == 'D' %}
                                    green
                                {% else %}
                                    grey
                                {% endif %}
                            {% endfor %}; {% if not is_subscriber %}pointer-events: none;{% endif %}">
                            üëé
                            {% for reaction_item in comments_reactions %}
                                {% if reaction_item.0 == comment.id %}
                                    {{ reaction_item.1.D|default:0 }}
                                {% endif %}
                            {% endfor %}
                        </a>
                    </span>

                    <span class="reaction-group">
                        <a href="{% url 'commentreaction' comment_id=comment.id reaction='H' %}"
                           class="reaction-button" data-reaction="H"
                           style="background-color: {% for reaction_item in user_comment_reactions %}
                                {% if reaction_item.0 == comment.id and reaction_item.1 == 'H' %}
                                    green
                                {% else %}
                                    grey
                                {% endif %}
                            {% endfor %}; {% if not is_subscriber %}pointer-events: none;{% endif %}">
                            ‚ù§Ô∏è
                            {% for reaction_item in comments_reactions %}
                                {% if reaction_item.0 == comment.id %}
                                    {{ reaction_item.1.H|default:0 }}
                                {% endif %}
                            {% endfor %}
                        </a>
                    </span>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</p>
    {% endif %}

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
    {% if is_subscriber %}
        <h2>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
    {% else %}
        <p>–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–º —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã. –ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.</p>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const reactionButtons = document.querySelectorAll('.reaction-button');
            reactionButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    const url = button.getAttribute('href');
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                    }).then(response => {
                        if (response.ok) {
                            window.location.reload();
                        }
                    });
                });
            });
        });
    </script>
{% endblock %}
